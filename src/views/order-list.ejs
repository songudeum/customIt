<!doctype html>
<html lang="ko">

<head>
    <%- include('../views/partials/head'); %>
        <link rel="stylesheet" href="/css/header.css" />
        <link rel="stylesheet" href="/css/footer.css" />
        <link rel="stylesheet" href="/css/order-list.css" />
</head>

<body>
    <header class="header"><%- include('../views/partials/header'); %></header>
    <main role="main" class="contents">
        <div class="contents-inner">
            <div class="order-aside-wrap">
                <section class="user-aside">
                    <div id="snb" class="snb_my">
                        <h2 class="tit_snb">마이페이지</h2>
                        <div class="inner_sub">
                            <ul class="list_menu">
                                <li class="on">
                                    <a href="#">
                                        주문 내역
                                    </a>
                                </li>

                                <li>
                                    <a href="/users/info">개인 정보 수정</a>
                                </li>
                                <li>
                                    <a href="/users/info/edit/pw">비밀번호 변경</a>
                                </li>
                                <li>
                                    <a href="/users/info/delete">회원 탈퇴 하기</a>
                                </li>
                            </ul>
                        </div>
                    </div>
                    <div class="order-contents">
                        <div class="title-wrap">
                            <p class="cont-title">주문 내역</p>
                            <div class="horizontal-line"></div>
                        </div>

                        <div class="order-list-wrap">
                            <ul class="order-list">
                                <li class="order-item">
                                    <div class="date-tit">
                                        <span>2023.07.06</span>
                                        <a href="/cancel" class="btn-cancel">주문취소</a>
                                    </div>

                                    <a href="" class="order-box">
                                        <div class="thum">
                                            <img src="/image/img-product01.jpg" alt="" class="상품 대표 이미지" />
                                        </div>
                                        <ul class="order-infobox">
                                            <li class="item">
                                                <p class="sub">주문번호</p>
                                                <p class="desc">
                                                    <%= orderList.orderId %>
                                                </p>
                                            </li>
                                            <li class="item">
                                                <p class="sub">결제금액</p>
                                                <p class="desc">
                                                    <%= orderList.totalPrice %>원
                                                </p>
                                            </li>
                                            <li class="item">
                                                <p class="sub">주문상태</p>
                                                <p class="order-status" data-order-status="상품 준비중">
                                                    <%= orderList.deliveryStatus %>
                                                </p>
                                            </li>
                                        </ul>
                                    </a>
                                </li>
                            </ul>
                        </div>
                        <div class="order-list-wrap">
                            <ul class="order-list">
                                <li class="order-item">
                                    <div class="date-tit">
                                        <span>2023.07.06</span>
                                        <a href="/cancel" class="btn-cancel">주문취소</a>
                                    </div>

                                    <a href="" class="order-box">
                                        <div class="thum">
                                            <img src="/image/img-product01.jpg" alt="" class="상품 대표 이미지" />
                                        </div>
                                        <ul class="order-infobox">
                                            <li class="item">
                                                <p class="sub">주문번호</p>
                                                <p class="desc">
                                                    <%= orderList.orderId %>
                                                </p>
                                            </li>
                                            <li class="item">
                                                <p class="sub">결제금액</p>
                                                <p class="desc">
                                                    <%= orderList.totalPrice %>원
                                                </p>
                                            </li>
                                            <li class="item">
                                                <p class="sub">주문상태</p>
                                                <p class="order-status" data-order-status="상품 준비중">
                                                    <%= orderList.deliveryStatus %>
                                                </p>
                                            </li>
                                        </ul>
                                    </a>
                                </li>
                            </ul>
                        </div>
                        <div class="order-list-wrap">
                            <ul class="order-list">
                                <li class="order-item">
                                    <div class="date-tit">
                                        <span>2023.07.06</span>
                                        <a href="/cancel" class="btn-cancel">주문취소</a>
                                    </div>

                                    <a href="" class="order-box">
                                        <div class="thum">
                                            <img src="/image/img-product01.jpg" alt="" class="상품 대표 이미지" />
                                        </div>
                                        <ul class="order-infobox">
                                            <li class="item">
                                                <p class="sub">주문번호</p>
                                                <p class="desc">
                                                    <%= orderList.orderId %>
                                                </p>
                                            </li>
                                            <li class="item">
                                                <p class="sub">결제금액</p>
                                                <p class="desc">
                                                    <%= orderList.totalPrice %>원
                                                </p>
                                            </li>
                                            <li class="item">
                                                <p class="sub">주문상태</p>
                                                <p class="order-status" data-order-status="상품 준비중">
                                                    <%= orderList.deliveryStatus %>
                                                </p>
                                            </li>
                                        </ul>
                                    </a>
                                </li>
                            </ul>
                        </div>
                        <p id="error-message"></p>
                    </div>
                </section>
            </div>

        </div>
        </div>
    </main>

    <footer class="footer"><%- include('../views/partials/footer'); %></footer>
    <script>
        console.log(orderList);
        document.addEventListener('DOMContentLoaded', function () {
            // 주문 조회 기능
            // '/api/orders' 라는 경로에서 주문 내역을 가져온다면
            let a = fetch('/order/test1@test.com/orderList', {
                headers: {
                    'Content-Type': 'application/json',
                    Accept: 'application/json',
                },
                method: 'GET',
            })
                .then((response) => response.json())
                .then((data) =>
                    // data를 사용하여 주문 내역을 표시
                    console.log(data),
                );

            // 주문 취소 기능
            const cancelButtons = document.querySelectorAll('.btn-cancel');
            cancelButtons.forEach((button) => {
                button.addEventListener('click', function () {
                    const orderId = this.parentNode.parentNode.dataset.orderId;
                    fetch(`/api/orders/${orderId}`, {
                        method: 'DELETE',
                    })
                        .then((response) => {
                            if (!response.ok) {
                                throw new Error('Order cancellation failed');
                            }
                            // 주문 취소가 성공하면, 주문 취소 버튼을 비활성화
                            this.disabled = true;
                            alert('주문이 취소되었습니다.');
                        })
                        .catch((error) => {
                            const errorMessageElement =
                                document.getElementById('error-message');
                            errorMessageElement.textContent = error.message; // 에러 메시지를 HTML 요소에 표시
                        });
                });
            });
            // 각 주문 아이템에 대해
            const orderItems = document.querySelectorAll('.order-item');
            orderItems.forEach((orderItem) => {
                // 주문 상태를 확인하고
                const orderStatus =
                    orderItem.querySelector('.order-status').dataset.orderStatus;

                // 만약 주문 상태가 '배송중' 이나 '배송완료'이면,
                if (orderStatus === '배송중' || orderStatus === '배송완료') {
                    // 주문 취소 버튼을 숨김
                    const cancelButton = orderItem.querySelector('.btn-cancel');
                    if (cancelButton) {
                        cancelButton.style.display = 'none';
                    }
                }
            });
        });
    </script>
</body>

</html>